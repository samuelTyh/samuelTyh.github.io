<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Building a Scalable ETL Pipeline for AdTech Analytics" />
<meta property="og:locale" content="en" />
<meta name="description" content="In the world of digital advertising, data is everything. Transforming raw operational data into actionable insights requires robust analytics pipelines. Recently, I implemented a comprehensive ETL (Extract, Transform, Load) solution for an advertising platform that moves data from PostgreSQL to ClickHouse for high-performance analytics. Let me walk you through the process, design decisions, and implementation details." />
<meta property="og:description" content="In the world of digital advertising, data is everything. Transforming raw operational data into actionable insights requires robust analytics pipelines. Recently, I implemented a comprehensive ETL (Extract, Transform, Load) solution for an advertising platform that moves data from PostgreSQL to ClickHouse for high-performance analytics. Let me walk you through the process, design decisions, and implementation details." />
<link rel="canonical" href="http://localhost:4000/posts/building-a-scalable-etl-pipeline-for-adtech-analytics/" />
<meta property="og:url" content="http://localhost:4000/posts/building-a-scalable-etl-pipeline-for-adtech-analytics/" />
<meta property="og:site_name" content="samueltyh" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-21T17:47:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Building a Scalable ETL Pipeline for AdTech Analytics" />
<meta name="twitter:site" content="@samueltyh" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-21T17:47:00+02:00","datePublished":"2025-04-21T17:47:00+02:00","description":"In the world of digital advertising, data is everything. Transforming raw operational data into actionable insights requires robust analytics pipelines. Recently, I implemented a comprehensive ETL (Extract, Transform, Load) solution for an advertising platform that moves data from PostgreSQL to ClickHouse for high-performance analytics. Let me walk you through the process, design decisions, and implementation details.","headline":"Building a Scalable ETL Pipeline for AdTech Analytics","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/building-a-scalable-etl-pipeline-for-adtech-analytics/"},"url":"http://localhost:4000/posts/building-a-scalable-etl-pipeline-for-adtech-analytics/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Building a Scalable ETL Pipeline for AdTech Analytics | samueltyh
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/AvatarMaker.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">samueltyh</a>
    <p class="site-subtitle fst-italic mb-0">Data Engineering, Learning by making, Career reflections</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tag"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    

      
        <a
          href="https://github.com/samueltyh"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    

      
        <a
          href="https://twitter.com/samueltyh"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    

      
        <a
          href="javascript:location.href = 'mailto:' + ['samuel.tseng.de','gmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
          
        

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Building a Scalable ETL Pipeline for AdTech Analytics</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Building a Scalable ETL Pipeline for AdTech Analytics</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1745250420"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr 21, 2025
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/samueltyh">Samuel Tseng</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3540 words"
>
  <em>19 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Building a Scalable ETL Pipeline for AdTech Analytics</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Building a Scalable ETL Pipeline for AdTech Analytics</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <p>In the world of digital advertising, data is everything. Transforming raw operational data into actionable insights requires robust analytics pipelines. Recently, I implemented a comprehensive ETL (Extract, Transform, Load) solution for an advertising platform that moves data from PostgreSQL to ClickHouse for high-performance analytics. Let me walk you through the process, design decisions, and implementation details.</p>

<h2 id="overview-of-the-challenge"><span class="me-2">Overview of the Challenge</span><a href="#overview-of-the-challenge" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>The challenge was to build a pipeline that would:</p>

<ol>
  <li>Extract campaign, impression, and click data from a PostgreSQL operational database</li>
  <li>Transform the data into an analytics-friendly format</li>
  <li>Load it into ClickHouse, a columnar DBMS optimized for analytical queries</li>
  <li>Create materialized views for key advertising KPIs</li>
</ol>

<p>The solution needed to handle both initial data loads and incremental updates, with robust error handling and monitoring capabilities.</p>

<h2 id="architecture-design"><span class="me-2">Architecture Design</span><a href="#architecture-design" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>After reviewing the requirements, I designed the following architecture:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>PostgreSQL (Source) → ETL Pipeline → ClickHouse (Target)
</pre></td></tr></tbody></table></code></div></div>

<h3 id="source-database-postgresql"><span class="me-2">Source Database (PostgreSQL)</span><a href="#source-database-postgresql" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The operational database contained four primary tables:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">advertiser</code>: Information about companies running ad campaigns</li>
  <li><code class="language-plaintext highlighter-rouge">campaign</code>: Campaign configurations with bid amounts and budgets</li>
  <li><code class="language-plaintext highlighter-rouge">impressions</code>: Records of ads being displayed</li>
  <li><code class="language-plaintext highlighter-rouge">clicks</code>: Records of users clicking on ads</li>
</ul>

<h3 id="target-schema-clickhouse"><span class="me-2">Target Schema (ClickHouse)</span><a href="#target-schema-clickhouse" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>For the analytical layer, I designed a dimensional model with:</p>

<ul>
  <li>Dimension tables:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dim_advertiser</code></li>
      <li><code class="language-plaintext highlighter-rouge">dim_campaign</code></li>
    </ul>
  </li>
  <li>Fact tables:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">fact_impressions</code></li>
      <li><code class="language-plaintext highlighter-rouge">fact_clicks</code></li>
    </ul>
  </li>
  <li>Materialized views for KPIs:
    <ul>
      <li>Campaign CTR (Click-Through Rate)</li>
      <li>Daily performance metrics</li>
      <li>Campaign daily performance</li>
      <li>Cost efficiency metrics</li>
      <li>Advertiser performance overviews</li>
    </ul>
  </li>
</ul>

<h2 id="implementation-details"><span class="me-2">Implementation Details</span><a href="#implementation-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="1-setting-up-the-core-components"><span class="me-2">1. Setting Up the Core Components</span><a href="#1-setting-up-the-core-components" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>I implemented the ETL pipeline in Python 3.12 with a modular design to separate concerns:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">.config</span> <span class="kn">import</span> <span class="n">AppConfig</span><span class="p">,</span> <span class="n">PostgresConfig</span><span class="p">,</span> <span class="n">ClickhouseConfig</span><span class="p">,</span> <span class="n">ETLConfig</span>
<span class="kn">from</span> <span class="n">.db</span> <span class="kn">import</span> <span class="n">PostgresConnector</span><span class="p">,</span> <span class="n">ClickhouseConnector</span>
<span class="kn">from</span> <span class="n">.schema</span> <span class="kn">import</span> <span class="n">SchemaManager</span>
<span class="kn">from</span> <span class="n">.pipeline</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DataExtractor</span><span class="p">,</span> <span class="n">DataTransformer</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">ETLPipeline</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-database-connectors"><span class="me-2">2. Database Connectors</span><a href="#2-database-connectors" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The first components I built were the database connectors, which encapsulate connection management and query execution:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">PostgresConnector</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">PostgreSQL connection manager.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PostgresConfig</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize with PostgreSQL configuration.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Establish connection to PostgreSQL database.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span>
                <span class="n">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">connection_string</span><span class="p">,</span>
                <span class="n">autocommit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Connected to PostgreSQL database</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to connect to PostgreSQL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="c1"># Additional methods for query execution, etc.
</span></pre></td></tr></tbody></table></code></div></div>

<p>Similarly, I implemented a <code class="language-plaintext highlighter-rouge">ClickhouseConnector</code> for managing ClickHouse connections:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ClickhouseConnector</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">ClickHouse connection manager.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ClickhouseConfig</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize with ClickHouse configuration.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="c1"># Methods for connection, query execution, etc.
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="3-schema-management"><span class="me-2">3. Schema Management</span><a href="#3-schema-management" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>I created a <code class="language-plaintext highlighter-rouge">SchemaManager</code> class to handle ClickHouse schema setup and updates:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SchemaManager</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Manages ClickHouse schema creation and updates.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db_connector</span><span class="p">:</span> <span class="n">ClickhouseConnector</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ETLConfig</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize with ClickHouse connector and configuration.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_connector</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    
    <span class="k">def</span> <span class="nf">setup_schema</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Initialize ClickHouse schema if not exists.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="nf">execute_file</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">schema_path</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">ClickHouse schema initialized successfully</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error setting up ClickHouse schema: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="4-the-etl-pipeline-components"><span class="me-2">4. The ETL Pipeline Components</span><a href="#4-the-etl-pipeline-components" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The core of the implementation consists of three main components:</p>

<h4 id="a-data-extractor"><span class="me-2">A. Data Extractor</span><a href="#a-data-extractor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DataExtractor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Extracts data from PostgreSQL source database.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">PostgresConnector</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize with PostgreSQL connector.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    
    <span class="k">def</span> <span class="nf">extract_advertisers</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">since</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Extract advertisers updated since the given timestamp.</span><span class="sh">"""</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
            SELECT id, name, updated_at, created_at 
            FROM advertiser
            WHERE updated_at &gt; %s OR created_at &gt; %s
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="nf">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">since</span><span class="p">,</span> <span class="n">since</span><span class="p">))</span>
    
    <span class="c1"># Additional methods for extracting campaigns, impressions, clicks
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="b-data-transformer"><span class="me-2">B. Data Transformer</span><a href="#b-data-transformer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DataTransformer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Transforms data for loading into ClickHouse.</span><span class="sh">"""</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_advertisers</span><span class="p">(</span><span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Transform advertiser data for ClickHouse.</span><span class="sh">"""</span>
        <span class="n">transformed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">adv_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">,</span> <span class="n">created_at</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">transformed</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span>
                <span class="n">adv_id</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">updated_at</span> <span class="ow">or</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">(),</span>
                <span class="n">created_at</span> <span class="ow">or</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="n">transformed</span>
    
    <span class="c1"># Additional transformation methods
</span></pre></td></tr></tbody></table></code></div></div>

<h4 id="c-data-loader"><span class="me-2">C. Data Loader</span><a href="#c-data-loader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Loads transformed data into ClickHouse.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">ClickhouseConnector</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize with ClickHouse connector.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    
    <span class="k">def</span> <span class="nf">load_advertisers</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Load advertiser data into ClickHouse.</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
            
        <span class="n">query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
            INSERT INTO analytics.dim_advertiser
            (advertiser_id, name, updated_at, created_at)
            VALUES
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="nf">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="c1"># Additional loading methods
</span></pre></td></tr></tbody></table></code></div></div>

<h3 id="5-orchestrating-the-etl-process"><span class="me-2">5. Orchestrating the ETL Process</span><a href="#5-orchestrating-the-etl-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>I created an <code class="language-plaintext highlighter-rouge">ETLPipeline</code> class to orchestrate the entire process:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ETLPipeline</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Main ETL pipeline that orchestrates extract, transform, and load.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> 
        <span class="n">extractor</span><span class="p">:</span> <span class="n">DataExtractor</span><span class="p">,</span> 
        <span class="n">transformer</span><span class="p">:</span> <span class="n">DataTransformer</span><span class="p">,</span> 
        <span class="n">loader</span><span class="p">:</span> <span class="n">DataLoader</span>
    <span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize with extractor, transformer, and loader components.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">extractor</span> <span class="o">=</span> <span class="n">extractor</span>
        <span class="n">self</span><span class="p">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_sync</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">advertiser</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nb">min</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">campaign</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nb">min</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">impressions</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nb">min</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">clicks</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nb">min</span>
        <span class="p">}</span>
        
        <span class="c1"># Tracking for sync statistics
</span>        <span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">advertiser</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">campaign</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">impressions</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">clicks</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">run_sync_cycle</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Run a complete ETL cycle.</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Starting ETL sync cycle</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># Reset sync statistics
</span>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Sync dimension tables first
</span>            <span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">advertiser</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sync_advertisers</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">campaign</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sync_campaigns</span><span class="p">()</span>
            
            <span class="c1"># Then sync fact tables
</span>            <span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">impressions</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sync_impressions</span><span class="p">()</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">clicks</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">sync_clicks</span><span class="p">()</span>
            
            <span class="c1"># Log sync summary
</span>            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">ETL sync cycle completed successfully</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Sync summary: </span><span class="sh">"</span>
                       <span class="sa">f</span><span class="sh">"</span><span class="s">Advertisers: </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">advertiser</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">, </span><span class="sh">"</span>
                       <span class="sa">f</span><span class="sh">"</span><span class="s">Campaigns: </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">campaign</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">, </span><span class="sh">"</span>
                       <span class="sa">f</span><span class="sh">"</span><span class="s">Impressions: </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">impressions</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">, </span><span class="sh">"</span>
                       <span class="sa">f</span><span class="sh">"</span><span class="s">Clicks: </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">sync_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">clicks</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="bp">True</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ETL sync cycle failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="6-implementing-incremental-updates"><span class="me-2">6. Implementing Incremental Updates</span><a href="#6-implementing-incremental-updates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>One of the most critical aspects of the implementation was handling incremental updates efficiently. I designed the system to track the last sync timestamp for each entity:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">sync_advertisers</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Sync advertisers from PostgreSQL to ClickHouse.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract only data updated since last sync
</span>        <span class="n">rows</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">extractor</span><span class="p">.</span><span class="nf">extract_advertisers</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">last_sync</span><span class="p">[</span><span class="sh">'</span><span class="s">advertiser</span><span class="sh">'</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">No new advertisers to sync</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="c1"># Transform and load
</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">transformer</span><span class="p">.</span><span class="nf">transform_advertisers</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="nf">load_advertisers</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Update the last sync timestamp
</span>        <span class="n">latest_update</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">last_sync</span><span class="p">[</span><span class="sh">'</span><span class="s">advertiser</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">,</span> <span class="n">created_at</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">updated_at</span> <span class="ow">and</span> <span class="n">updated_at</span> <span class="o">&gt;</span> <span class="n">latest_update</span><span class="p">:</span>
                <span class="n">latest_update</span> <span class="o">=</span> <span class="n">updated_at</span>
            <span class="k">if</span> <span class="n">created_at</span> <span class="ow">and</span> <span class="n">created_at</span> <span class="o">&gt;</span> <span class="n">latest_update</span><span class="p">:</span>
                <span class="n">latest_update</span> <span class="o">=</span> <span class="n">created_at</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">last_sync</span><span class="p">[</span><span class="sh">'</span><span class="s">advertiser</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">latest_update</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Synced </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s"> advertisers</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">count</span>
        
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error syncing advertisers: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="7-main-service-loop"><span class="me-2">7. Main Service Loop</span><a href="#7-main-service-loop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Finally, I implemented a main service class to tie everything together:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">run_service</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">run_once</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">force_full_sync</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Run the ETL service continuously or once.</span><span class="sh">"""</span>
    <span class="n">sync_interval</span> <span class="o">=</span> <span class="n">interval</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">etl</span><span class="p">.</span><span class="n">sync_interval</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="nf">initialize</span><span class="p">():</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Service initialization failed. Exiting.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">force_full_sync</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Forcing full sync - resetting all sync timestamps</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">etl_pipeline</span><span class="p">.</span><span class="n">last_sync</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">etl_pipeline</span><span class="p">.</span><span class="n">last_sync</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nb">min</span>
    
    <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">AdTech ETL service started with sync interval: </span><span class="si">{</span><span class="n">sync_interval</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">run_once</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Continuous operation
</span>            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_sync</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">warning</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Waiting </span><span class="si">{</span><span class="n">sync_interval</span><span class="si">}</span><span class="s"> seconds before retry...</span><span class="sh">"</span><span class="p">)</span>
                
                <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Sleeping for </span><span class="si">{</span><span class="n">sync_interval</span><span class="si">}</span><span class="s"> seconds...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">sync_interval</span><span class="p">)</span>
                
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">ETL service interrupted, shutting down</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up resources
</span>        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">pg_connector</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">pg_connector</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">ch_connector</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">ch_connector</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="clickhouse-optimization"><span class="me-2">ClickHouse Optimization</span><a href="#clickhouse-optimization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>A key part of the solution was optimizing the ClickHouse schema for analytical queries:</p>

<div class="language-sql highlighter-rouge"><div class="code-header">
        <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">-- Dimension tables with ReplacingMergeTree engine</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">analytics</span><span class="p">.</span><span class="n">dim_advertiser</span>
<span class="p">(</span>
    <span class="n">advertiser_id</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">name</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">updated_at</span> <span class="nb">DateTime</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="nb">DateTime</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">ReplacingMergeTree</span><span class="p">(</span><span class="n">updated_at</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="p">(</span><span class="n">advertiser_id</span><span class="p">);</span>

<span class="c1">-- Fact tables with partitioning</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">analytics</span><span class="p">.</span><span class="n">fact_impressions</span>
<span class="p">(</span>
    <span class="n">impression_id</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">campaign_id</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">event_date</span> <span class="nb">Date</span><span class="p">,</span>
    <span class="n">event_time</span> <span class="nb">DateTime</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="nb">DateTime</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">()</span>
<span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">toYYYYMM</span><span class="p">(</span><span class="n">event_date</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="p">(</span><span class="n">campaign_id</span><span class="p">,</span> <span class="n">event_date</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="materialized-views-for-kpis"><span class="me-2">Materialized Views for KPIs</span><a href="#materialized-views-for-kpis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>I created several materialized views to pre-calculate common KPIs:</p>

<div class="language-sql highlighter-rouge"><div class="code-header">
        <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="c1">-- Materialized view for campaign CTR</span>
<span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">analytics</span><span class="p">.</span><span class="n">mv_campaign_ctr</span>
<span class="p">(</span>
    <span class="n">campaign_id</span> <span class="n">UInt32</span><span class="p">,</span>
    <span class="n">campaign_name</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">advertiser_name</span> <span class="n">String</span><span class="p">,</span>
    <span class="n">impressions</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="n">clicks</span> <span class="n">UInt64</span><span class="p">,</span>
    <span class="n">ctr</span> <span class="n">Float64</span>
<span class="p">)</span>
<span class="n">ENGINE</span> <span class="o">=</span> <span class="n">SummingMergeTree</span><span class="p">()</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="p">(</span><span class="n">campaign_id</span><span class="p">)</span>
<span class="n">POPULATE</span> <span class="k">AS</span>
<span class="k">SELECT</span>
    <span class="k">c</span><span class="p">.</span><span class="n">campaign_id</span><span class="p">,</span>
    <span class="k">c</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">campaign_name</span><span class="p">,</span>
    <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">advertiser_name</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">i</span><span class="p">.</span><span class="n">impression_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">impressions</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">cl</span><span class="p">.</span><span class="n">click_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">clicks</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">cl</span><span class="p">.</span><span class="n">click_id</span><span class="p">)</span> <span class="o">/</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">i</span><span class="p">.</span><span class="n">impression_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">ctr</span>
<span class="k">FROM</span> <span class="n">dim_campaign</span> <span class="k">c</span>
<span class="k">JOIN</span> <span class="n">dim_advertiser</span> <span class="n">a</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">advertiser_id</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">advertiser_id</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">fact_impressions</span> <span class="n">i</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">campaign_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">campaign_id</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">fact_clicks</span> <span class="n">cl</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="n">campaign_id</span> <span class="o">=</span> <span class="n">cl</span><span class="p">.</span><span class="n">campaign_id</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">campaign_id</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="testing"><span class="me-2">Testing</span><a href="#testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>I implemented comprehensive testing with pytest to ensure the reliability of the ETL pipeline:</p>

<ol>
  <li><strong>Unit tests</strong> for individual components</li>
  <li><strong>Integration tests</strong> for the end-to-end pipeline</li>
  <li><strong>Schema tests</strong> for database schema validation</li>
</ol>

<p>For example, the unit tests for the Transformer component:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nd">@pytest.mark.unit</span>
<span class="k">class</span> <span class="nc">TestDataTransformer</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Tests for DataTransformer.</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">test_transform_advertisers</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Test transforming advertiser data.</span><span class="sh">"""</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">Advertiser A</span><span class="sh">'</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">now</span><span class="p">)]</span>
        
        <span class="n">transformer</span> <span class="o">=</span> <span class="nc">DataTransformer</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">transformer</span><span class="p">.</span><span class="nf">transform_advertisers</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">Advertiser A</span><span class="sh">'</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">now</span><span class="p">)]</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="deployment-with-docker"><span class="me-2">Deployment with Docker</span><a href="#deployment-with-docker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>I containerized the entire solution using Docker to ensure consistent operation:</p>

<div class="language-dockerfile highlighter-rouge"><div class="code-header">
        <span data-label-text="Dockerfile"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> python:3.12-slim</span>

<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="c"># Install dependencies</span>
<span class="k">COPY</span><span class="s"> requirements.txt .</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-cache-dir</span> <span class="nt">-r</span> requirements.txt

<span class="c"># Copy ETL files</span>
<span class="k">COPY</span><span class="s"> . .</span>

<span class="c"># Run the ETL script</span>
<span class="k">CMD</span><span class="s"> ["python", "main.py"]</span>
</pre></td></tr></tbody></table></code></div></div>

<p>And orchestrated the services with Docker Compose:</p>

<div class="language-yaml highlighter-rouge"><div class="code-header">
        <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="na">services</span><span class="pi">:</span>
  <span class="c1"># PostgreSQL</span>
  <span class="na">postgres</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:17</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">psql_source</span>
    <span class="na">env_file</span><span class="pi">:</span> <span class="s">.env</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">6543:5432"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">postgres_data:/var/lib/postgresql/data</span>
    
  <span class="c1"># ClickHouse</span>
  <span class="na">clickhouse</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">clickhouse/clickhouse-server</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">ch_analytics</span>
    <span class="na">env_file</span><span class="pi">:</span> <span class="s">.env</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8124:8123"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9001:9000"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">clickhouse_data:/var/lib/clickhouse</span>
  
  <span class="c1"># ETL Service</span>
  <span class="na">etl</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./etl</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile.etl</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">adtech_etl</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="na">postgres</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">service_healthy</span>
      <span class="na">clickhouse</span><span class="pi">:</span>
        <span class="na">condition</span><span class="pi">:</span> <span class="s">service_healthy</span>
    <span class="na">env_file</span><span class="pi">:</span> <span class="s">.env</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./etl:/app</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="cicd-pipeline"><span class="me-2">CI/CD Pipeline</span><a href="#cicd-pipeline" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>To ensure code quality, I set up a GitHub Actions workflow:</p>

<div class="language-yaml highlighter-rouge"><div class="code-header">
        <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">CI</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span><span class="pi">,</span> <span class="nv">dev</span> <span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span><span class="pi">,</span> <span class="nv">dev</span> <span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">lint</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Code Quality Checks</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Python </span><span class="m">3.12</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-python@v5</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">python-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.12'</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">python -m pip install --upgrade pip</span>
          <span class="s">pip install ruff==0.11.0</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Lint with ruff</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">python -m ruff check etl tests</span>

  <span class="na">test</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Unit Tests</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Python </span><span class="m">3.12</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-python@v5</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">python-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.12'</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">python -m pip install --upgrade pip</span>
          <span class="s">pip install -r etl/requirements.txt</span>
          <span class="s">pip install pytest==8.3.5</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run unit tests</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">python -m pytest -xvs -m "unit"</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="scalability-approaches"><span class="me-2">Scalability Approaches</span><a href="#scalability-approaches" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>As data volumes grow in advertising platforms, the ETL pipeline must scale accordingly. Here are the key scalability approaches I implemented and recommend for further expansion:</p>

<h3 id="1-horizontal-scaling-with-distributed-processing"><span class="me-2">1. Horizontal Scaling with Distributed Processing</span><a href="#1-horizontal-scaling-with-distributed-processing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>The current architecture can be enhanced for horizontal scalability by implementing:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DistributedETLPipeline</span><span class="p">(</span><span class="n">ETLPipeline</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Distributed version of the ETL pipeline that supports partitioned processing.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">extractor</span><span class="p">,</span> <span class="n">transformer</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">partition_count</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">extractor</span><span class="p">,</span> <span class="n">transformer</span><span class="p">,</span> <span class="n">loader</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">partition_count</span> <span class="o">=</span> <span class="n">partition_count</span>
        
    <span class="k">def</span> <span class="nf">partition_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">date_field</span><span class="p">,</span> <span class="n">partition_key</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Create logical partitions for parallel processing.</span><span class="sh">"""</span>
        <span class="n">partition_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Calculate partition boundaries based on time or ID ranges
</span>        <span class="k">return</span> <span class="n">partition_ranges</span>
        
    <span class="k">def</span> <span class="nf">run_partitioned_sync</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">executor</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Execute sync operations across multiple partitions in parallel.</span><span class="sh">"""</span>
        <span class="n">partitions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">partition_data</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="sh">'</span><span class="s">created_at</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">partition</span> <span class="ow">in</span> <span class="n">partitions</span><span class="p">:</span>
            <span class="c1"># Submit each partition for parallel execution
</span>            <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sync_partition</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">partition</span><span class="p">)</span>
            <span class="n">futures</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
            
        <span class="c1"># Gather results
</span>        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">future</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
        <span class="k">return</span> <span class="nf">sum</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>With this approach, we can use Python’s <code class="language-plaintext highlighter-rouge">concurrent.futures</code> or distributed task queues like Celery to process partitions in parallel across multiple worker nodes.</p>

<h3 id="2-time-based-batching-for-high-volume-tables"><span class="me-2">2. Time-Based Batching for High-Volume Tables</span><a href="#2-time-based-batching-for-high-volume-tables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>For fact tables with millions of daily records (impressions, clicks), implementing time-based batching reduces memory pressure:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">sync_impressions_with_batching</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">time_window_hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Sync impressions with time-based batching.</span><span class="sh">"""</span>
    <span class="n">total_synced</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">last_sync</span><span class="p">[</span><span class="sh">'</span><span class="s">impressions</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
    
    <span class="k">while</span> <span class="n">current_time</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>
        <span class="c1"># Calculate next batch window
</span>        <span class="n">next_window</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">time_window_hours</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_window</span> <span class="o">&gt;</span> <span class="n">end_time</span><span class="p">:</span>
            <span class="n">next_window</span> <span class="o">=</span> <span class="n">end_time</span>
            
        <span class="c1"># Extract and process just this time window
</span>        <span class="n">rows</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">extractor</span><span class="p">.</span><span class="nf">extract_impressions_by_window</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">next_window</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">transformer</span><span class="p">.</span><span class="nf">transform_impressions</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="nf">load_impressions</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">total_synced</span> <span class="o">+=</span> <span class="n">count</span>
            
        <span class="c1"># Move to next window
</span>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">next_window</span>
        
    <span class="c1"># Update the final sync timestamp
</span>    <span class="n">self</span><span class="p">.</span><span class="n">last_sync</span><span class="p">[</span><span class="sh">'</span><span class="s">impressions</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>
    <span class="k">return</span> <span class="n">total_synced</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-database-level-scaling"><span class="me-2">3. Database-Level Scaling</span><a href="#3-database-level-scaling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>As the system scales, the database architecture can be enhanced:</p>

<h4 id="postgresql-scaling"><span class="me-2">PostgreSQL Scaling:</span><a href="#postgresql-scaling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<ul>
  <li>Implement read replicas to isolate the ETL read load from operational writes</li>
  <li>Use logical replication with PostgreSQL’s Change Data Capture (CDC) features</li>
  <li>Consider a replication-based CDC tool like Debezium for near real-time data streaming</li>
</ul>

<h4 id="clickhouse-scaling"><span class="me-2">ClickHouse Scaling:</span><a href="#clickhouse-scaling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<ul>
  <li>Implement a ClickHouse cluster with data sharding across multiple nodes</li>
  <li>Optimize the sharding key for commonly queried dimensions (e.g., by campaign_id)</li>
  <li>Implement distributed tables to abstract the sharding complexity:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="code-header">
        <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1">-- Distributed table definition</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">analytics</span><span class="p">.</span><span class="n">dist_fact_impressions</span> 
<span class="k">AS</span> <span class="n">analytics</span><span class="p">.</span><span class="n">fact_impressions</span>
<span class="n">ENGINE</span> <span class="o">=</span> <span class="n">Distributed</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">analytics</span><span class="p">,</span> <span class="n">fact_impressions</span><span class="p">,</span> <span class="n">rand</span><span class="p">());</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="4-resilient-work-queue-architecture"><span class="me-2">4. Resilient Work Queue Architecture</span><a href="#4-resilient-work-queue-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>For extreme scale, transition from a scheduled polling approach to an event-driven architecture:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1"># In a message consumer service
</span><span class="k">def</span> <span class="nf">process_etl_message</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Process a message from the ETL work queue.</span><span class="sh">"""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">entity_type</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">entity_type</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">batch_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">batch_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">time_range</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        
        <span class="c1"># Process the specific batch
</span>        <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">impressions</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">etl_pipeline</span><span class="p">.</span><span class="nf">sync_impressions_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">time_range</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">clicks</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">etl_pipeline</span><span class="p">.</span><span class="nf">sync_clicks_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">time_range</span><span class="p">)</span>
        <span class="c1"># etc.
</span>        
        <span class="c1"># Acknowledge successful processing
</span>        <span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="nf">acknowledge</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Failed processing - handle with retry logic
</span>        <span class="n">self</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="nf">retry</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to process ETL message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This approach works well with Apache Kafka, RabbitMQ, or cloud-native solutions like AWS SQS/SNS for truly decoupled processing.</p>

<h2 id="optimization-techniques"><span class="me-2">Optimization Techniques</span><a href="#optimization-techniques" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Beyond the initial implementation, I’ve identified several optimization opportunities:</p>

<h3 id="1-query-optimization-for-extraction"><span class="me-2">1. Query Optimization for Extraction</span><a href="#1-query-optimization-for-extraction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Improving extraction performance through optimized queries:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">extract_impressions_optimized</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">since</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Extract impressions with optimized query performance.</span><span class="sh">"""</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
        SELECT id, campaign_id, created_at
        FROM impressions
        WHERE created_at &gt; %s
        ORDER BY created_at
        LIMIT 50000  -- Batch size control
    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="nf">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">since</span><span class="p">,))</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Additionally, I recommend adding appropriate indexes to source tables:</p>

<div class="language-sql highlighter-rouge"><div class="code-header">
        <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">-- Add index for incremental extraction performance</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_impressions_created_at</span> <span class="k">ON</span> <span class="n">impressions</span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">idx_clicks_created_at</span> <span class="k">ON</span> <span class="n">clicks</span><span class="p">(</span><span class="n">created_at</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-batch-processing-and-bulk-loading"><span class="me-2">2. Batch Processing and Bulk Loading</span><a href="#2-batch-processing-and-bulk-loading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Implementing bulk loading operations for ClickHouse significantly improves throughput:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">load_impressions_bulk</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Load impression data into ClickHouse using efficient bulk loading.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="c1"># Prepare data for bulk insert
</span>    <span class="n">formatted_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">imp_id</span><span class="p">,</span> <span class="n">campaign_id</span><span class="p">,</span> <span class="n">event_date</span><span class="p">,</span> <span class="n">event_time</span><span class="p">,</span> <span class="n">created_at</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">formatted_data</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">'</span><span class="s">impression_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">imp_id</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">campaign_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">campaign_id</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">event_date</span><span class="sh">'</span><span class="p">:</span> <span class="n">event_date</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">event_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">event_time</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">created_at</span><span class="sh">'</span><span class="p">:</span> <span class="n">created_at</span>
        <span class="p">})</span>
    
    <span class="c1"># Execute bulk insert
</span>    <span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">INSERT INTO analytics.fact_impressions VALUES</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">formatted_data</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-memory-management"><span class="me-2">3. Memory Management</span><a href="#3-memory-management" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>For large datasets, implement iterator-based processing to avoid loading entire result sets into memory:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">extract_large_dataset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">since</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Extract large datasets using server-side cursors to control memory usage.</span><span class="sh">"""</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
        SELECT id, campaign_id, created_at 
        FROM impressions
        WHERE created_at &gt; %s
        ORDER BY id
    </span><span class="sh">"""</span>
    
    <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">large_extract_cursor</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">since</span><span class="p">,))</span>
        
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="nf">fetchmany</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">yield</span> <span class="n">batch</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="4-compression-and-data-type-optimizations"><span class="me-2">4. Compression and Data Type Optimizations</span><a href="#4-compression-and-data-type-optimizations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Optimize ClickHouse storage by carefully selecting compression and data types:</p>

<div class="language-sql highlighter-rouge"><div class="code-header">
        <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">-- Optimized fact table with compression and efficient data types</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">analytics</span><span class="p">.</span><span class="n">fact_impressions_optimized</span>
<span class="p">(</span>
    <span class="n">impression_id</span> <span class="n">UInt32</span> <span class="n">CODEC</span><span class="p">(</span><span class="n">Delta</span><span class="p">,</span> <span class="n">LZ4</span><span class="p">),</span>
    <span class="n">campaign_id</span> <span class="n">UInt32</span> <span class="n">CODEC</span><span class="p">(</span><span class="n">Delta</span><span class="p">,</span> <span class="n">LZ4</span><span class="p">),</span>
    <span class="n">event_date</span> <span class="nb">Date</span> <span class="n">CODEC</span><span class="p">(</span><span class="n">DoubleDelta</span><span class="p">,</span> <span class="n">LZ4</span><span class="p">),</span>
    <span class="n">event_time</span> <span class="nb">DateTime</span> <span class="n">CODEC</span><span class="p">(</span><span class="n">DoubleDelta</span><span class="p">,</span> <span class="n">LZ4</span><span class="p">),</span>
    <span class="n">created_at</span> <span class="nb">DateTime</span> <span class="n">CODEC</span><span class="p">(</span><span class="n">DoubleDelta</span><span class="p">,</span> <span class="n">LZ4</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">MergeTree</span><span class="p">()</span>
<span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">toYYYYMM</span><span class="p">(</span><span class="n">event_date</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="p">(</span><span class="n">campaign_id</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span>
<span class="n">SETTINGS</span> <span class="n">index_granularity</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="5-parallel-processing-for-transformations"><span class="me-2">5. Parallel Processing for Transformations</span><a href="#5-parallel-processing-for-transformations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Implement parallel transformation processing for CPU-intensive operations:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">transform_impressions_parallel</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Transform impression data using parallel processing.</span><span class="sh">"""</span>
    <span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
    
    <span class="c1"># Split data into chunks for parallel processing
</span>    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>
    
    <span class="c1"># Process chunks in parallel
</span>    <span class="k">with</span> <span class="nc">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">executor</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_transform_impression_chunk</span><span class="p">,</span> <span class="n">chunks</span><span class="p">))</span>
    
    <span class="c1"># Combine results
</span>    <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="future-proofing-the-architecture"><span class="me-2">Future-Proofing the Architecture</span><a href="#future-proofing-the-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>As digital advertising continues to evolve, this ETL pipeline can be extended in several ways:</p>

<h3 id="1-streaming-data-processing"><span class="me-2">1. Streaming Data Processing</span><a href="#1-streaming-data-processing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Implement real-time data processing by integrating with streaming platforms:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">StreamingETLPipeline</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Real-time streaming ETL pipeline for advertising events.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kafka_config</span><span class="p">,</span> <span class="n">clickhouse_connector</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="nc">KafkaConsumer</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">adtech.events</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">kafka_config</span><span class="p">[</span><span class="sh">'</span><span class="s">bootstrap_servers</span><span class="sh">'</span><span class="p">],</span>
            <span class="n">group_id</span><span class="o">=</span><span class="sh">'</span><span class="s">etl-consumer-group</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">auto_offset_reset</span><span class="o">=</span><span class="sh">'</span><span class="s">earliest</span><span class="sh">'</span>
        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">clickhouse</span> <span class="o">=</span> <span class="n">clickhouse_connector</span>
        
    <span class="k">def</span> <span class="nf">process_streaming_events</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process streaming events from Kafka.</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
            
            <span class="c1"># Process different event types
</span>            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">impression</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">process_impression</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">click</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">process_click</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">process_impression</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Process impression event and load to ClickHouse.</span><span class="sh">"""</span>
        <span class="c1"># Transform and load impression data
</span>        <span class="n">self</span><span class="p">.</span><span class="n">clickhouse</span><span class="p">.</span><span class="nf">execute_query</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">INSERT INTO analytics.fact_impressions VALUES</span><span class="sh">"</span><span class="p">,</span>
            <span class="p">[(</span>
                <span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">campaign_id</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">datetime</span><span class="p">.</span><span class="nf">fromisoformat</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">]).</span><span class="nf">date</span><span class="p">(),</span>
                <span class="n">datetime</span><span class="p">.</span><span class="nf">fromisoformat</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">]),</span>
                <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
            <span class="p">)]</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="2-machine-learning-feature-store-integration"><span class="me-2">2. Machine Learning Feature Store Integration</span><a href="#2-machine-learning-feature-store-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Extend the pipeline to support ML feature generation for predictive advertising:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">FeatureStoreLoader</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Loads transformed data into a feature store for ML applications.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">clickhouse_connector</span><span class="p">,</span> <span class="n">feature_store_client</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">clickhouse</span> <span class="o">=</span> <span class="n">clickhouse_connector</span>
        <span class="n">self</span><span class="p">.</span><span class="n">feature_store</span> <span class="o">=</span> <span class="n">feature_store_client</span>
        
    <span class="k">def</span> <span class="nf">generate_campaign_features</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate and load campaign performance features.</span><span class="sh">"""</span>
        <span class="c1"># Extract features from ClickHouse
</span>        <span class="n">features_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">clickhouse</span><span class="p">.</span><span class="nf">execute_query</span><span class="p">(</span><span class="sh">"""</span><span class="s">
            SELECT 
                campaign_id,
                toDate(event_time) AS day,
                count() AS daily_impressions,
                sum(case when exists(
                    SELECT 1 FROM analytics.fact_clicks c 
                    WHERE c.campaign_id = i.campaign_id AND c.event_date = i.event_date
                ) then 1 else 0 end) AS daily_clicks,
                avg(bid) AS avg_bid
            FROM analytics.fact_impressions i
            JOIN analytics.dim_campaign c ON i.campaign_id = c.campaign_id
            GROUP BY campaign_id, day
            ORDER BY campaign_id, day
        </span><span class="sh">"""</span><span class="p">)</span>
        
        <span class="c1"># Load to feature store
</span>        <span class="n">self</span><span class="p">.</span><span class="n">feature_store</span><span class="p">.</span><span class="nf">ingest_features</span><span class="p">(</span>
            <span class="n">feature_group</span><span class="o">=</span><span class="sh">"</span><span class="s">campaign_daily_performance</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">features_data</span>
        <span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="3-multi-tenant-architecture"><span class="me-2">3. Multi-Tenant Architecture</span><a href="#3-multi-tenant-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Scale the system to support multiple advertising platforms through tenant isolation:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MultiTenantETLPipeline</span><span class="p">(</span><span class="n">ETLPipeline</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">ETL pipeline with tenant isolation support.</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tenant_id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tenant_id</span> <span class="o">=</span> <span class="n">tenant_id</span>
        
    <span class="k">def</span> <span class="nf">extract_tenant_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">since</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Extract data specifically for this tenant.</span><span class="sh">"""</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">
            SELECT * FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s"> 
            WHERE tenant_id = %s AND updated_at &gt; %s
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">extractor</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="nf">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tenant_id</span><span class="p">,</span> <span class="n">since</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">load_tenant_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Load data with tenant isolation.</span><span class="sh">"""</span>
        <span class="c1"># Ensure tenant_id is included in all loaded data
</span>        <span class="n">tenant_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">self</span><span class="p">.</span><span class="n">tenant_id</span><span class="p">,)</span> <span class="o">+</span> <span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="nf">load_generic</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tenant_data</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Building this ETL pipeline for AdTech analytics was a structured exercise in balancing performance, reliability, and maintainability. The modular design allows for easy extension to additional data sources or targets, while the ClickHouse optimizations ensure fast query responses for critical KPIs.</p>

<p>While the current implementation meets the immediate needs, I’ve outlined clear paths for scaling and optimizing as data volumes grow. The real power of this architecture lies in its flexibility—it can evolve from batch processing to streaming, accommodate multi-tenant requirements, and integrate with advanced analytics platforms as business needs change.</p>

<p>For organizations starting similar projects, I recommend taking an incremental approach: begin with the core batch ETL functionality, validate the data model with real queries, then progressively enhance with optimizations and scalability features based on actual performance metrics and growth patterns.</p>

<p>This architectural pattern has proven highly effective for advertising analytics, where the ability to process billions of events while maintaining query performance is critical to driving business value through data-driven decision making.</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/data-engineering/">Data Engineering</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/python/"
            class="post-tag no-text-decoration"
          >python</a>
        
          <a
            href="/tags/postgres/"
            class="post-tag no-text-decoration"
          >postgres</a>
        
          <a
            href="/tags/etl/"
            class="post-tag no-text-decoration"
          >etl</a>
        
          <a
            href="/tags/clickhouse/"
            class="post-tag no-text-decoration"
          >clickhouse</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Building%20a%20Scalable%20ETL%20Pipeline%20for%20AdTech%20Analytics%20-%20samueltyh&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fbuilding-a-scalable-etl-pipeline-for-adtech-analytics%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Building%20a%20Scalable%20ETL%20Pipeline%20for%20AdTech%20Analytics%20-%20samueltyh&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fbuilding-a-scalable-etl-pipeline-for-adtech-analytics%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fbuilding-a-scalable-etl-pipeline-for-adtech-analytics%2F&text=Building%20a%20Scalable%20ETL%20Pipeline%20for%20AdTech%20Analytics%20-%20samueltyh" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/year-end-reflection-landing-a-new-job-in-2025/">Year end reflection: landing a new job in 2025</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/useful-gadget-sharing-cron-job-org/">Useful gadget sharing - cron-job.org</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/setting-both-celery-and-flask-inside-the-docker-compose/">Setting both Celery and Flask inside the docker-compose</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/free-n8n-hosting-leveraging-hugging-face-spaces-and-supabase-for-persistent-workflow-automation/">Free n8n Hosting: Leveraging Hugging Face Spaces and Supabase for Persistent Workflow Automation</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/terraform-for-data-engineers-automating-your-data-infrastructure/">Terraform for Data Engineers: Automating Your Data Infrastructure</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/etl/">etl</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/devops/">devops</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/postgres/">postgres</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/airflow/">airflow</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/application/">application</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/azure-data-studio/">azure-data-studio</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/building-a-production-ready-data-pipeline-with-airflow-and-dbt/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1745843400"
  data-df="ll"
  
>
  Apr 28, 2025
</time>

              <h4 class="pt-0 my-2">Building a Production-Ready Data Pipeline with Airflow and dbt</h4>
              <div class="text-muted">
                <p>A comprehensive walkthrough of implementing a modern sales data engineering pipeline with Airflow, dbt, and PostgreSQL, focusing on practical insights and real-world patterns.</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/implementing-fivetran-data-source-connector-with-aws-lambda/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1653770820"
  data-df="ll"
  
>
  May 28, 2022
</time>

              <h4 class="pt-0 my-2">Implementing Fivetran Data Source Connector with AWS Lambda</h4>
              <div class="text-muted">
                <p>Basic background of AWS Lambda  Official developer guide from AWS  AWS Lambda is a serverless, event-driven compute service that lets you run code for virtually any type of application or backend s...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/run-your-own-apache-spark-jobs-in-aws-emr-and-s3/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1612137600"
  data-df="ll"
  
>
  Feb  1, 2021
</time>

              <h4 class="pt-0 my-2">Run your own Apache Spark jobs in AWS EMR and S3</h4>
              <div class="text-muted">
                <p>Run your own Apache Spark jobs in AWS EMR and S3  Recently, I participated in Udacity’s Nanodegree Program for Data Engineers. It’s kinda like to review what I did past and refresh some tech stacks...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/takeaway-unit-testing-of-bash-scripts/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Takeaway: Unit Testing of Bash Scripts</p>
    </a>
  

  
    <a
      href="/posts/building-a-production-ready-data-pipeline-with-airflow-and-dbt/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Building a Production-Ready Data Pipeline with Airflow and dbt</p>
    </a>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://twitter.com/samueltyh">Samuel Tseng</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/etl/">etl</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/devops/">devops</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/postgres/">postgres</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/airflow/">airflow</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/application/">application</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/azure-data-studio/">azure-data-studio</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->

  
  <script>
  var disqus_config = function () {
    this.page.url = 'http://localhost:4000/posts/building-a-scalable-etl-pipeline-for-adtech-analytics/';
    this.page.identifier = '/posts/building-a-scalable-etl-pipeline-for-adtech-analytics/';
  };

  function addDisqus() {
    let disqusThread = document.createElement('div');
    let paragraph = document.createElement('p');

    disqusThread.id = 'disqus_thread';
    paragraph.className = 'text-center text-muted small';
    paragraph.innerHTML = 'Comments powered by <a href="https://disqus.com/">Disqus</a>.';
    disqusThread.appendChild(paragraph);

    const footer = document.querySelector('footer');
    footer.insertAdjacentElement("beforebegin", disqusThread);
  }function reloadDisqus(event) {
    if (event.source === window && event.data && event.data.id === Theme.ID) {if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  addDisqus();

  if (Theme.switchable) {
    addEventListener('message', reloadDisqus);
  }var disqusObserver = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        var d = document,
          s = d.createElement('script');
        s.src = 'https://samuelTyh.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);

        disqusObserver.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqusObserver.observe(document.getElementById('disqus_thread'));
</script>



    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

